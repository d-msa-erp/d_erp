<!DOCTYPE html>
<html lang="ko">

<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>MRP 관리</title>
	<th:block th:replace="~{/icon.html :: iconInclude}"></th:block>
	<style th:replace="~{/top.html :: topstyle}"></style>
	<style>
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}

		body {
			font-family: sans-serif;
			display: flex;
			flex-direction: column;
			justify-content: center;
		}

		.site-Wrapper {
			width: 100%;
			max-width: 1200px;
			align-self: center;
			padding: 20px;
		}

		.site-Dataset {
			width: 100%;
			border: 1px solid #777;
			border-radius: 10px;
			overflow: hidden;
			display: flex;
			flex-direction: column;
		}

		.site-Dataset .header {
			background: #46a6ff;
			color: white;
			padding: 10px 20px;
			font-size: 20px;
		}

		.site-Dataset .form-content {
			display: flex;
			flex-wrap: wrap;
			padding: 20px;
			gap: 20px;
		}

		.form-item {
			display: flex;
			align-items: center;
			width: calc(33.333% - 13.33px);
		}

		.form-item.addr {
			width: calc(66.666% - 10px);
		}

		.form-item span {
			padding-right: 10px;
			white-space: nowrap;
		}

		.form-item input {
			width: 100%;
			height: 100%;
			border-radius: 3px;
			padding: 5px;
			font-size: 14px;
			border: 1px solid #ccc;
		}

		.form-item input:focus {
			border: 1px solid #46a6ff;
			outline: none;
		}

		.table-wrapper {
			width: 100%;
			max-width: 1200px;
		}

		.table-wrapper>div:nth-child(1) {
			padding: 20px 20px 0 20px;
			display: flex;
			justify-content: flex-end;
			gap: 20px;
			position: relative;
		}

		.table-wrapper>div:nth-child(1)>input[type="text"] {
			width: 30%;
			padding: 5px;
		}

		.table-wrapper>div:nth-child(1)>div {
			width: 30%;
			display: flex;
			justify-content: space-between;
		}

		.table-wrapper>div:nth-child(1)>.btn-wrap1 {
			background: #fff;
			border: none;
			border-radius: 5px;
			position: absolute;
			left: 20px;
			display: flex;
			justify-content: flex-start;
			gap: 10px;
		}

		.table-wrapper>div:nth-child(1)>div button {
			width: 30%;
			background: #fff;
			border: none;
			border-radius: 5px;
			cursor: pointer;
			white-space: nowrap;
		}

		.table-wrapper>div:nth-child(1)>.btn-wrap1 button {
			padding: 5px;
			gap: 10px;
			background: #fff;
			border: none;
			border-radius: 5px;
			cursor: pointer;
			white-space: nowrap;
		}

		.table-wrapper>div:nth-child(1)>div button:nth-child(1) {
			background: #007bff;
			color: white;
		}

		.table-wrapper>div:nth-child(1)>div button:nth-child(2) {
/* 			background: #28a745; */
			background: #dc3545;
			color: white;
		}

		.table-wrapper>div:nth-child(1)>div button:nth-child(3) {
			background: #dc3545;
			color: white;
		}

		.table-wrapper>div:nth-child(2) {
			padding: 20px 20px 0 20px;
			display: flex;
			flex-direction: column;
		}

		.table-wrapper>div:nth-child(2)>span {
			width: 30%;
			padding-right: 10px;
			text-align: center;
			cursor: pointer;
		}

		.table-wrapper>div:nth-child(2)>span.active {
			font-weight: bold;
			text-decoration: underline;
		}

		.table-wrapper>div:nth-child(3) {
			position: relative;
		}

		.nodata {
			text-align: center;
		}

		.print-wrap {
			position: absolute;
			top: 0;
			right: 0;
			padding: 0 20px;
			display: flex;
			gap: 10px;
			width: 300px;
		}

		.print-wrap>button {
			width: 100%;
			background: #007bff;
			color: #fff;
			border: none;
			border-radius: 5px;
			cursor: pointer;
			padding: 5px;
		}

		.grid-table {
			width: 100%;
			border-collapse: collapse;
			display: grid;
			grid-template-columns: 1fr 2fr 2fr 2fr 2fr 1fr 1fr 1fr;
		}
        .grid-table2{
            width: 100%;
			border-collapse: collapse;
			display: grid;
			grid-template-columns: 1fr 2fr 2fr 1fr 1fr 1fr 2fr;
        }
		thead,
		tbody,
		tr {
			display: contents;
		}

		tbody>tr:nth-child(even) td {
			background: #f9f9f9;
		}

		tbody>tr:hover td {
			background: #46a6ff;
			cursor: pointer;
		}

		tr th:nth-child(1),
		tr td:nth-child(1),
		tr th:nth-last-child(1) {
			justify-content: center;
		}

		tr td:nth-last-child(1) {
			justify-content: right;
		}

		th,
		td {
			padding: 10px;
			border: 1px solid #ccc;
			display: flex;
			align-items: center;
		}

		thead th {
			background: #f0f0f0;
			font-weight: bold;
			cursor: pointer;
		}

		table input[type="text"] {
			width: 100%;
			padding: 5px;
		}

		.pagination-wrap {
			display: flex;
			flex-direction: column;
			align-items: flex-end;
			padding-top: 20px;
		}

		.pagination-wrap>div {
			display: flex;
			align-items: center;
			gap: 10px;
		}

		.pagination-wrap>div input[type="text"] {
			width: 50px;
			text-align: center;
		}

		.pagination-wrap>div button {
			width: 20px;
			background: #007bff;
			color: white;
			border: none;
			border-radius: 5px;
			cursor: pointer;
		}

		.table-wrapper button:hover {
			filter: brightness(0.9);
		}
		.modal {
			display: none;
			position: fixed;
			top: 0;
			left: 0;
			width: 100vw;
			height: 100vh;
			background: rgba(0, 0, 0, 0.4);
			justify-content: center;
			align-items: center;
			backdrop-filter: blur(4px);
			-webkit-backdrop-filter: blur(4px);
		}

		.modal-content {
			background: white;
			padding: 20px;
			border-radius: 10px;
			width: 80%;
			position: relative;
		}

		.modal-content .modalForm {
			margin-top: 20px;
			display: flex;
			flex-direction: column;
			gap: 20px;
			justify-items: center;
			align-items: center;
		}

		.modal-content .modalForm>div,
		.modal-content .modalForm>label {
			width: 100%;
			display: flex;
			justify-content: space-between;
			align-items: center;
		}

		.modal-content .modalForm>div>span,
		.modal-content .modalForm>label>span {
			white-space: nowrap;
			padding-right: 10px;
		}

		.modal-content input[type="text"] {
			width: 100%;
			padding: 10px;
			border: 1px solid #ccc;
		}

		.modal-content input[type="color"] {
			width: 100%;
			height: 40px;
			border: none;
			margin-top: 10px;
		}

		.modal-content .modal-buttons {
			margin-top: 15px;
			display: flex;
			justify-content: flex-end;
			gap: 10px;
			width: 100%;
			grid-column-start: 3;
		}

		.modal-content .modal-buttons>button:hover {
			filter: brightness(0.9);
		}

		.modal-content .modal-buttons>button {
			width: 100%;
			background: #007bff;
			color: #fff;
			border: none;
			border-radius: 5px;
			cursor: pointer;
			padding: 5px;
		}

		.modal-buttons button:nth-of-type(3) {
			background: #777 !important;
		}

		.modal-content .modalForm th,
		.modal-content .modalForm td {
			margin: 0 !important;
			padding: 0 !important;
			width: 100% !important;
			height: 100% !important;
		}

		.modal-content .bomTab1 select {
			height: 100%;
			width: 100%;
		}

		.modal-content .grid-table {
			width: 100%;
			height: 100%;
			border-collapse: collapse;
			display: grid;
			grid-template-columns: 1fr 2fr 2fr 1fr 1fr;
			padding: 0;
		}

		.bomTab1 {
			display: grid !important;
			grid-template-columns: 1fr 1fr;
			gap: 10px;
		}
		.bomTab1 input{height: 100%; width: 100%; padding: 5px;}
.bomTab1 > div {
	height: 100%;
	align-self: stretch;
}
		.bomTab2 {
			display: grid;
			grid-template-columns: 2.7fr 1fr;
			gap: 10px;
		}

		.bomTab2>div {
			display: flex;
			flex-direction: column;
			gap: 10px !important;
			justify-content: space-between;
			overflow-y: auto;
		}
		.bomTab2>div>div {height: 100%;}

		.bomTab2>div>ul {
			display: flex;
			flex-direction: column;
			height: 100%;
		}

		.bomTab2>div>ul>li {
			padding-left: 10px;
		}
		.bomTab3{
			display: flex;
			flex-direction: column;
			gap: 10px;
		}
		.bomTab3>div {
			display: flex;
			white-space: nowrap;
			gap: 10px;
			align-items: center;
		}

		.bomTab3 .flex-row {
			display: flex;
			gap: 10px;
			width: 100%;
		}

		.bomTab3 .flex-row>div {
			flex: 1;
			display: flex;
			align-items: center;
		}

		.bomTab3 .flex-row>div span {
			white-space: nowrap;
			padding-right: 10px;
		}

		.bomTab3 .flex-row>div input {
			width: 100%;
		}
		.bomTab5 {max-height: 300px; overflow-y: auto;}
		.bomTab5 .grid-table{
			grid-template-columns: 1fr 2fr 2fr 1fr 1fr 1fr 1fr 1fr;
		}
	</style>

</head>

<body>
	<div th:replace="~{/top.html :: top}"></div>
	<div class="site-Wrapper">
		<h1 style="font-size: 24px; margin-bottom: 16px;">MRP 관리</h1>
		<form id="frm" method="get" action="#">
			<div class="site-Dataset">
				<div class="header">
					<h4 style="margin: 0;">MRP 관리</h4>
				</div>
				<div class="table-wrapper">
					<div>
						
						<input type="text" id="mrpsearchInput" placeholder="상품명을 입력하세요" />
						<div>
							<button type="button" id="mrpSearchBtn">
								<span class="material-symbols-outlined">search</span> 검색
							</button>
<!-- 							<button type="button" onclick="openModal()"> -->
<!-- 								<span class="material-symbols-outlined">add</span> 1 -->
<!-- 							</button> -->
							<button type="button">
								<span class="material-symbols-outlined">delete</span> 삭제
							</button>
						</div>
					</div>
					<div></div>
					<div id="table-customer" style="padding: 20px;position: relative;display: flex;flex-direction: column;gap: 20px;">
						<div class="print-wrap">
							<button type="button">
								<span class="material-symbols-outlined">calculate</span> 계산
							</button>
							<button type="button">
								<span class="material-symbols-outlined">table_view</span> 엑셀
							</button>
							<button type="button">
								<span class="material-symbols-outlined">print</span> 인쇄
							</button>
						</div>
						<!--데이터 없을 땐 이렇게 표기-->
						<table class="grid-table">

							<thead>

								<tr>
									<th><input type="checkbox" /></th>
									<th onclick="order(this)">주문번호<a>↓</a></th>
									<th onclick="order(this)">품목코드<a>↓</a></th>
									<th onclick="order(this)">품목명<a>↓</a></th>
									<th onclick="order(this)">고객사<a>↓</a></th>
									<th onclick="order(this)">규격<a>↓</a></th>
									<th onclick="order(this)">단위<a>↓</a></th>
									<th onclick="order(this)">수량<a>↓</a></th>
								</tr>
							</thead>
							<tbody>
									<tr>
									<td class="nodata" style="grid-column: span 8;justify-content: center;">등록된 데이터가 없습니다.</td>
								</tr>
								<!--몇개씩 자를지는 상의해봐요 ~ -->
								<tr onclick="opendatail()">
									<td><input type="checkbox" /></td>
									<td>test</td>
									<td>test</td>
									<td>test</td>
									<td>test</td>
									<td>test</td>
									<td>test</td>
									<td>10000000</td>
								</tr>
<<<<<<< Updated upstream
								<tr>
									<td><input type="checkbox" /></td>
									<td>test</td>
									<td>test</td>
									<td>test</td>
									<td>test</td>
									<td>test</td>
									<td>test</td>
									<td>100000000</td>
								</tr>
=======
>>>>>>> Stashed changes
							</tbody>
						</table>

                        <table class="grid-table2">

							<thead>

								<tr>
									<th onclick="order(this)">NO<a>↓</a></th>
									<th onclick="order(this)">자재코드<a>↓</a></th>
									<th onclick="order(this)">자재명<a>↓</a></th>
									<th onclick="order(this)">규격<a>↓</a></th>
									<th onclick="order(this)">소요량<a>↓</a></th>
									<th onclick="order(this)">단위<a>↓</a></th>
									<th onclick="order(this)">투입예상량<a>↓</a></th>
								</tr>
							</thead>
							<tbody>
									<tr>
									<td class="nodata" style="grid-column: span 7;justify-content: center;">등록된 데이터가 없습니다.</td>
								</tr>
								
								<!--몇개씩 자를지는 상의해봐요 ~ -->
								<tr onclick="opendatail()">
									<td>1</td>
									<td>test</td>
									<td>test</td>
									<td>test</td>
									<td>test</td>
									<td>test</td>
									<td>100</td>
								</tr>
							</tbody>
						</table>

						
					</div>


				</div>
			</div>
		</form>
	</div>

	<!--신규 등록 Modal-->
	<div class="modal" id="modal" onclick="outsideClick(event)">
		<div class="modal-content" onclick="event.stopPropagation()">
			<h3 id="modalTitle">신규 MRP 등록</h3>
			<form id="modalForm" class="modalForm">
				<div class="bomTab1">
					<div class="bomTab2">
						<div>
							<div>
								<table class="grid-table">
									<thead>
										<tr>
											<th>No</th>
											<th>품목코드</th>
											<th>품목명</th>
											<th>규격</th>
											<th>단위</th>
										</tr>
									</thead>
									<tbody>
										<!--등록된 품목 리스트가 쭉 나오게 ~ -->
										<tr>
											<td>1</td>
											<td><input type="text" value="test" /></td>
											<td><input type="text" value="test" /></td>
											<td><input type="text" value="test" /></td>
											<td><select>
													<option value="">--</option>
													<option value="g">g</option>
													<option value="kg">kg</option>
													<option value="mL">mL</option>
													<option value="L">L</option>
													<option value="ea">ea</option>
												</select></td>
										</tr>
										<tr>
											<td>2</td>
											<td><input type="text" value="test" /></td>
											<td><input type="text" value="test" /></td>
											<td><input type="text" value="test" /></td>
											<td><select>
													<option value="">--</option>
													<option value="g">g</option>
													<option value="kg">kg</option>
													<option value="mL">mL</option>
													<option value="L">L</option>
													<option value="ea">ea</option>
												</select></td>
										</tr>
									</tbody>
								</table>

							</div>
							<div>
								<table class="grid-table">
									<thead>
										<tr>
											<th>No</th>
											<th>자재코드</th>
											<th>자재명</th>
											<th>규격</th>
											<th>단위</th>
										</tr>
									</thead>
									<tbody>
										<!--등록된 자재 리스트가 쭉 나오게 ~ -->
										<tr>
											<td>1</td>
											<td><input type="text" value="test" /></td>
											<td><input type="text" value="test" /></td>
											<td><input type="text" value="test" /></td>
											<td><select>
													<option value="">--</option>
													<option value="g">g</option>
													<option value="kg">kg</option>
													<option value="mL">mL</option>
													<option value="L">L</option>
													<option value="ea">ea</option>
												</select></td>
										</tr>
										<tr>
											<td>2</td>
											<td><input type="text" value="test" /></td>
											<td><input type="text" value="test" /></td>
											<td><input type="text" value="test" /></td>
											<td><select>
													<option value="">--</option>
													<option value="g">g</option>
													<option value="kg">kg</option>
													<option value="mL">mL</option>
													<option value="L">L</option>
													<option value="ea">ea</option>
												</select></td>
										</tr>
									</tbody>
								</table>

							</div>
						</div>

					</div>

					<div class="bomTab3">
							<div class="flex-row">
							<div><span>발주번호</span><input type="text" /></div>
							<div><span>수량</span><input type="text" /></div>
						</div>
						<div><span>품목코드</span><input type="text" /></div>
						<div><span>품목명</span><input type="text" /></div>
						<div class="flex-row">
							<div><span>원자재코드</span><input type="text" /></div>
							<div><span>순번</span><input type="text" /></div>
						</div>
						<div><span>원자재명</span><input type="text" /></div>
						<div class="flex-row">
							<div><span>소요량</span><input type="text" /></div>
							<div><span>재료비</span><input type="text" /></div>
						</div>
						<div class="flex-row">
							<div><span>로스율</span><input type="text" /></div>
							<div><span>생산성</span><input type="text" /></div>
						</div>
						<div><span>비고</span><input type="text"/></div>
					</div>

				</div>
				<div class="bomTab5"> 
						<div>
							<div>
								<table class="grid-table">
									<thead>
										<tr>
											<th>No</th>
											<th>품목명</th>
											<th>원자재명</th>
											<th>순번</th>
											<th>소요량</th>
											<th>로스율</th>
											<th>재료비</th>
											<th>비고</th>
										</tr>
									</thead>
									<tbody>
										<!--등록된 품목 리스트가 쭉 나오게 ~ -->
										<tr>
											<td>1</td>
											<td><input type="text" value="test" /></td>
											<td><input type="text" value="test" /></td>
											<td><input type="text" value="test" /></td>
											<td><input type="text" value="test" /></td>
											<td><input type="text" value="test" /></td>
											<td><input type="text" value="test" /></td>
											<td><input type="text" value="test" /></td>
											
										</tr>
										<tr>
											<td>2</td>
											<td><input type="text" value="test" /></td>
											<td><input type="text" value="test" /></td>
											<td><input type="text" value="test" /></td>
											<td><input type="text" value="test" /></td>
											<td><input type="text" value="test" /></td>
											<td><input type="text" value="test" /></td>
											<td><input type="text" value="test" /></td>
										</tr>
										<tr>
											<td>3</td>
											<td><input type="text" value="test" /></td>
											<td><input type="text" value="test" /></td>
											<td><input type="text" value="test" /></td>
											<td><input type="text" value="test" /></td>
											<td><input type="text" value="test" /></td>
											<td><input type="text" value="test" /></td>
											<td><input type="text" value="test" /></td>
										</tr>
						
									</tbody>
								</table>
							</div>
						</div>
				</div>
				<div class="modal-buttons">
					<button type="button" name="save">등록</button>
					<button type="button" name="edit">수정</button>
					<button type="button" onclick="closeModal()">취소</button>
				</div>
			</form>
		</div>

	</div>

	<script src="/js/top.js"></script>
	<script>
	let currentMrpOrderPage = 1;
	let totalMrpOrderPages = 1;
	const mrpPageSize = 5; // 페이지당 항목 수
    let currentSelectedOrderId = null; // 현재 선택된 주문 ID
	
    let mrpsearchInput, mrpSearchBtn, mrpOrderTableBody, mrpMaterialTableBody;
    let mrpOrderTotalCountSpan, mrpOrderCurrentPageSpan, mrpOrderPrevPageBtn, mrpOrderNextPageBtn, mrpOrderCurrentPageInput;
    let checkAllOrdersCheckbox;
    
	document.addEventListener('DOMContentLoaded', () => {
        // MRP 관리 페이지용 DOM 요소 할당
        mrpSearchInput = document.getElementById('mrpSearchInput');
        mrpSearchButton = document.getElementById('mrpSearchBtn');
        mrpOrderTableBody = document.getElementById('mrpOrderTableBody');
        mrpMaterialTableBody = document.getElementById('mrpMaterialTableBody');
        
        mrpOrderTotalCountSpan = document.getElementById('mrpOrderTotalCount');
        mrpOrderCurrentPageSpan = document.getElementById('mrpOrderCurrentPage');
        mrpOrderPrevPageBtn = document.getElementById('mrpOrderBtnPrevPage');
        mrpOrderNextPageBtn = document.getElementById('mrpOrderBtnNextPage');
        mrpOrderCurrentPageInput = document.getElementById('mrpOrderCurrentPageInput');
        checkAllOrdersCheckbox = document.getElementById('checkAllOrders');

        // 초기 MRP 대상 주문 목록 로드
        fetchMrpTargetOrders(currentMrpOrderPage, '');

        // 검색 버튼 이벤트 리스너
        if (mrpSearchBtn) {
        	mrpSearchBtn.addEventListener('click', () => {
                const searchTerm = mrpSearchInput.value.trim();
                fetchMrpTargetOrders(1, searchTerm); // 검색 시 1페이지부터
                clearMaterialTable(); // 새 검색 시 하단 테이블 초기화
            });
        }
        
        // 검색 입력창에서 Enter 키 입력 시 검색 실행
        if (mrpSearchInput) {
            mrpSearchInput.addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault(); // 폼 제출 방지
                    mrpSearchButton.click(); // 검색 버튼 클릭 이벤트 트리거
                }
            });
        }

        // 페이지네이션 버튼 이벤트 리스너
        if (mrpOrderPrevPageBtn) {
            mrpOrderPrevPageBtn.addEventListener('click', () => {
                if (currentMrpOrderPage > 1) {
                    fetchMrpTargetOrders(currentMrpOrderPage - 1, mrpSearchInput.value.trim());
                }
            });
        }
        if (mrpOrderNextPageBtn) {
            mrpOrderNextPageBtn.addEventListener('click', () => {
                if (currentMrpOrderPage < totalMrpOrderPages) {
                    fetchMrpTargetOrders(currentMrpOrderPage + 1, mrpSearchInput.value.trim());
                }
            });
        }
        if (mrpOrderCurrentPageInput) {
            mrpOrderCurrentPageInput.addEventListener('change', function() {
                const pageNumber = parseInt(this.value);
                if (!isNaN(pageNumber) && pageNumber >= 1 && pageNumber <= totalMrpOrderPages) {
                    fetchMrpTargetOrders(pageNumber, mrpSearchInput.value.trim());
                } else {
                    alert('유효한 페이지 번호를 입력하세요.');
                    this.value = currentMrpOrderPage;
                }
            });
        }

        // 테이블 내 체크박스 클릭 시 이벤트 전파 중지 (부모 tr의 opendatail 방지)
        // 이 로직은 테이블이 동적으로 생성될 때 각 체크박스에 대해 설정하거나 이벤트 위임 사용
        // 아래 fetchMrpTargetOrders 함수 내에서 각 행 생성 시 체크박스에 이벤트 리스너 추가하는 방식으로 변경
        
        // 전체 선택 체크박스 이벤트
        if(checkAllOrdersCheckbox) {
            checkAllOrdersCheckbox.addEventListener('change', function() {
                const checkboxes = mrpOrderTableBody.querySelectorAll('input[type="checkbox"]');
                checkboxes.forEach(checkbox => checkbox.checked = this.checked);
            });
        }

        // MRP 계산 버튼 이벤트 리스너 (예시)
        const calculateBtn = document.getElementById('mrpCalculateButton');
        if(calculateBtn) {
            calculateBtn.addEventListener('click', handleMrpCalculate);
        }

        // MRP 삭제 버튼 이벤트 리스너 (예시)
        const deleteBtn = document.getElementById('mrpDeleteButton');
        if(deleteBtn) {
            deleteBtn.addEventListener('click', handleMrpDelete);
        }

	});

    // MRP 대상 주문 목록 조회 함수
    async function fetchMrpTargetOrders(page, searchKeyword) {
        currentMrpOrderPage = page; // 현재 페이지 업데이트
        let url = `/api/mrp/orders?page=${page - 1}&size=${mrpPageSize}`; // 서버 API는 page를 0-indexed로 받을 수 있음
        if (searchKeyword) {
            url += `&searchKeyword=${encodeURIComponent(searchKeyword)}`;
        }
        // 만약 정렬 파라미터도 보낸다면 추가: &sort=orderIdx,desc 등

        try {
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const pageData = await response.json(); // Spring Page 객체 또는 유사 구조 가정
            
            mrpOrderTableBody.innerHTML = ''; // 테이블 초기화
            const noDataRow = mrpOrderTableBody.insertRow();
            noDataRow.innerHTML = `<td class="nodata" colspan="10" style="justify-content: center;">등록된 데이터가 없습니다.</td>`;
            noDataRow.style.display = 'none';


            if (pageData && pageData.content && pageData.content.length > 0) {
                const orders = pageData.content; // MrpFirstDto 배열
                orders.forEach(order => {
                    const row = mrpOrderTableBody.insertRow();
                    row.style.cursor = 'pointer';
                    // 행 클릭 시 두 번째 테이블 로드 및 모달 열기 (opendatail 대신 새 함수 사용)
                    row.addEventListener('click', () => handleOrderRowClick(order)); 

                    const cellCheckbox = row.insertCell();
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.value = order.orderId; // 주문 ID를 값으로 가짐
                    checkbox.onclick = (event) => event.stopPropagation(); // 이벤트 전파 중단
                    cellCheckbox.appendChild(checkbox);

                    row.insertCell().textContent = order.orderCode || '';
                    row.insertCell().textContent = order.productionCode || ''; // DTO에 productionCode 필드 필요
                    row.insertCell().textContent = order.itemCd || '';
                    row.insertCell().textContent = order.itemNm || '';
                    row.insertCell().textContent = order.customerNm || '';
                    row.insertCell().textContent = order.itemSpec || '';
                    row.insertCell().textContent = order.unitNm || '';
                    row.insertCell().textContent = order.orderQty === null ? '' : order.orderQty;
                    row.insertCell().textContent = order.productivity || ''; // DTO에 productivity 필드 필요
                });
                noDataRow.style.display = 'none';
            } else {
                mrpOrderTableBody.innerHTML = `<tr><td class="nodata" colspan="10" style="justify-content: center;">검색된 데이터가 없거나 등록된 데이터가 없습니다.</td></tr>`;
            }

            // 페이지네이션 정보 업데이트
            totalMrpOrderPages = pageData.totalPages || 1;
            mrpOrderTotalCountSpan.textContent = `총 ${pageData.totalElements || 0}건`;
            mrpOrderCurrentPageSpan.textContent = `${currentMrpOrderPage}/${totalMrpOrderPages}페이지`;
            mrpOrderCurrentPageInput.value = currentMrpOrderPage;
            mrpOrderPrevPageBtn.disabled = currentMrpOrderPage === 1;
            mrpOrderNextPageBtn.disabled = currentMrpOrderPage === totalMrpOrderPages || totalMrpOrderPages === 0;
            if(checkAllOrdersCheckbox) checkAllOrdersCheckbox.checked = false;


        } catch (error) {
            console.error("MRP 대상 주문 목록 조회 오류:", error);
            mrpOrderTableBody.innerHTML = `<tr><td class="nodata" colspan="10" style="justify-content: center;">데이터 조회 중 오류 발생</td></tr>`;
            mrpOrderTotalCountSpan.textContent = '총 0건';
            mrpOrderCurrentPageSpan.textContent = '1/1페이지';
            mrpOrderPrevPageBtn.disabled = true;
            mrpOrderNextPageBtn.disabled = true;
        }
    }

    // 주문 목록 행 클릭 시 처리 함수
    function handleOrderRowClick(orderData) {
        console.log("Selected Order Data:", orderData);
        currentSelectedOrderId = orderData.orderId; // 선택된 주문 ID 저장
        
        // 선택된 행 강조 표시 (선택적)
        document.querySelectorAll('#mrpOrderTableBody tr').forEach(r => r.classList.remove('selected-row'));
        event.currentTarget.classList.add('selected-row'); // event.currentTarget 사용 주의, orderData를 받은 함수이므로 직접 DOM 조작

        fetchMrpMaterialRequirements(orderData.orderId); // 두 번째 테이블 데이터 로드
        // opendatail(orderData); // 필요하다면 모달 열기 (orderData를 전달하도록 opendatail 수정 필요)
    }

    // 특정 주문에 대한 자재 소요량 목록 조회 함수
    async function fetchMrpMaterialRequirements(orderId) {
        if (!orderId) {
            clearMaterialTable("주문 ID가 없습니다.");
            return;
        }
        const url = `/api/mrp/orders/${orderId}/requirements`; // 또는 /exploded-bom
        try {
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const materials = await response.json(); // MaterialRequirementDto 배열

            mrpMaterialTableBody.innerHTML = ''; // 테이블 초기화
            const noDataRow = mrpMaterialTableBody.insertRow();
            noDataRow.innerHTML = `<td class="nodata" colspan="7" style="justify-content: center;">등록된 데이터가 없습니다.</td>`;
            noDataRow.style.display = 'none';

            if (materials && materials.length > 0) {
                materials.forEach((material, index) => {
                    const row = mrpMaterialTableBody.insertRow();
                    // row.onclick = () => opendatail(material); // 두 번째 테이블 클릭 시 동작 정의 필요

                    row.insertCell().textContent = index + 1; // NO
                    row.insertCell().textContent = material.materialCd || '';
                    row.insertCell().textContent = material.materialNm || '';
                    row.insertCell().textContent = material.materialSpec || '';
                    row.insertCell().textContent = material.requiredQty === null ? '' : material.requiredQty; // 소요량
                    row.insertCell().textContent = material.unitNm || '';
                    row.insertCell().textContent = material.expectedInputQty === null ? '' : material.expectedInputQty; // 투입예상량
                });
                noDataRow.style.display = 'none';
            } else {
                 mrpMaterialTableBody.innerHTML = `<tr><td class="nodata" colspan="7" style="justify-content: center;">해당 주문에 대한 자재 소요량 데이터가 없습니다.</td></tr>`;
            }
        } catch (error) {
            console.error("자재 소요량 목록 조회 오류:", error);
            clearMaterialTable("자재 소요량 조회 중 오류 발생");
        }
    }

    function clearMaterialTable(message = "상단에서 주문/계획을 선택해주세요.") {
        if(mrpMaterialTableBody){
             mrpMaterialTableBody.innerHTML = `<tr><td class="nodata" colspan="7" style="justify-content: center;">${message}</td></tr>`;
        }
    }

    // MRP 계산 처리 함수 (예시)
    async function handleMrpCalculate() {
        const selectedOrderIds = getSelectedOrderIds();
        if (selectedOrderIds.length === 0) {
            alert("계산할 주문을 선택해주세요.");
            return;
        }
        if (!confirm(`${selectedOrderIds.length}개 주문에 대해 MRP 계산을 실행하시겠습니까?`)) {
            return;
        }
        console.log("MRP 계산 실행 대상:", selectedOrderIds);
        try {
            const response = await fetch('/api/mrp/run-calculation', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ orderIds: selectedOrderIds })
            });
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ message: 'MRP 계산 요청 실패' }));
                throw new Error(errorData.message || response.statusText);
            }
            const resultMessage = await response.text();
            alert(resultMessage);
            fetchMrpTargetOrders(currentMrpOrderPage, mrpSearchInput.value.trim()); // 목록 새로고침
            if (currentSelectedOrderId) { // 현재 선택된 주문이 있다면 해당 주문의 자재 목록도 새로고침
                fetchMrpMaterialRequirements(currentSelectedOrderId);
            } else {
                clearMaterialTable();
            }
        } catch (error) {
            console.error("MRP 계산 요청 오류:", error);
            alert("MRP 계산 중 오류가 발생했습니다: " + error.message);
        }
    }
    
    // MRP 삭제 처리 함수 (예시)
    async function handleMrpDelete() {
        const selectedOrderIds = getSelectedOrderIds();
        if (selectedOrderIds.length === 0) {
            alert("삭제할 주문을 선택해주세요.");
            return;
        }
        if (!confirm(`${selectedOrderIds.length}개 주문(및 관련 MRP 계획)을 삭제하시겠습니까?`)) {
            return;
        }
        console.log("MRP 삭제 대상:", selectedOrderIds);
         try {
            const response = await fetch('/api/mrp/orders/batch-delete', { // 이전 제안 엔드포인트 사용
                method: 'POST', // 또는 DELETE (하지만 body로 List를 보내려면 POST가 편함)
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(selectedOrderIds) // List<Long> 바로 전달
            });
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ message: '삭제 요청 실패' }));
                throw new Error(errorData.message || response.statusText);
            }
            alert("선택된 항목이 삭제되었습니다.");
            fetchMrpTargetOrders(1, ''); // 첫 페이지로 이동 및 검색어 초기화
            clearMaterialTable();
        } catch (error) {
            console.error("MRP 삭제 요청 오류:", error);
            alert("삭제 중 오류가 발생했습니다: " + error.message);
        }
    }

    // 선택된 주문 ID들 가져오는 함수
    function getSelectedOrderIds() {
        const selectedIds = [];
        const checkboxes = mrpOrderTableBody.querySelectorAll('input[type="checkbox"]:checked');
        checkboxes.forEach(checkbox => {
            if (checkbox.value) { // value에 orderId가 있다고 가정
                selectedIds.push(parseInt(checkbox.value)); // 서버에서 Long으로 받으므로 parseInt 또는 parseFloat
            }
        });
        return selectedIds;
    }
		let currentTh = null;
		let currentOrder = 'desc';

		function order(thValue) {//정렬
			const allArrows = document.querySelectorAll("th a");
			allArrows.forEach(a => a.textContent = '↓');

			if (currentTh === thValue) {
				currentOrder = currentOrder === 'desc' ? 'asc' : 'desc';
			} else {
				currentOrder = 'asc';
				currentTh = thValue;
			}

			const arrow = thValue.querySelector('a');
			arrow.textContent = currentOrder === 'asc' ? '↑' : '↓';
		}





		//Modal ~ 
		function openModal() {
			const title = document.getElementById('modalTitle');
			title.textContent = '신규 MRP 등록';
			document.getElementById('modal').style.display = 'flex';
			document.querySelector('#modalForm button[name="save"]').style.display = 'block';
			document.querySelector('#modalForm button[name="edit"]').style.display = 'none';
		}

		function closeModal() {
			document.getElementById('modal').style.display = 'none';
		}

		function outsideClick(e) {
			if (e.target.id === 'modal') {
				closeModal();
			}
		}



		function submitModal(event) {
			event.preventDefault();
			const siteName = document.querySelector('#modalForm input[name="siteName"]').value;
			console.log(currentTab + ' 등록됨:', siteName);
			closeModal();
		}

		//테이블 클릭 시 출력되는 modal
		function opendatail() {
			openModal();
			document.getElementById('modalTitle').textContent = 'MRP 수정';

			document.querySelector('#modalForm button[name="save"]').style.display = 'none';
			document.querySelector('#modalForm button[name="edit"]').style.display = 'block';
		}
		
		document.addEventListener('DOMContentLoaded', () => {
			  document.querySelectorAll('table').forEach(table => {
			    const firstCells = table.querySelectorAll('tbody tr td:first-child');
			    firstCells.forEach(td => {
			      td.setAttribute('onclick', 'event.stopPropagation()');
			    });
			  });
			});
	</script>

</body>

</html>