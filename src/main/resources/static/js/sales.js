const companySearchInput = document.getElementById('companySearchInput');
const dataList = document.getElementById('companyList');
const selectedCustIdx = document.getElementById('selectedCustIdx');
const itemCycleTime = document.getElementById('itemCycleTime');
const itemList = document.getElementById('itemList');

const startDateInput = document.getElementById('sDate');
const quantityInput = document.getElementById('quantity');
const dueDateInput = document.getElementById('dueDate');
const cycleTimeInput = document.getElementById('itemCycleTime');
const today = new Date().toISOString().split('T')[0];

let itemDataMap = {};
let originalCustomerOptions = [];
let warehouseOptions = [];
let qtyLowData = [];
let currentTh = 'orderIdx';
let currentOrder = 'desc';
let currentPage = 0;
let isDueDate = false;

document.addEventListener('DOMContentLoaded', () => {
	// ÌÉ≠ Î°úÎî©
	loadSales('orderIdx', 'desc', isDueDate);

	const selectAllMainCb = document.getElementById('selectAllCheckbox'); // Î©îÏù∏ ÌÖåÏù¥Î∏îÏùò Ï†ÑÏ≤¥ ÏÑ†ÌÉù Ï≤¥ÌÅ¨Î∞ïÏä§ ID
	if (selectAllMainCb) selectAllMainCb.addEventListener('change', function() {
		document.querySelectorAll('#salesTableBody .sales-checkbox').forEach(cb => {
			cb.checked = this.checked;
		});
	});

	document.getElementById("btn-prev-page")?.addEventListener('click', () => {
		if (currentPage > 0) {
			currentPage--;
			loadSales(currentTh, currentOrder, isDueDate);
		}
	});

	document.getElementById("btn-next-page")?.addEventListener('click', () => {
		if (currentPage < totalPages - 1) {
			currentPage++;
			loadSales(currentTh, currentOrder, isDueDate);
		}
	});

	document.getElementById("currentPageInput")?.addEventListener('keypress', (e) => {
		if (e.key === 'Enter') {
			const page = parseInt(e.target.value);
			if (!isNaN(page) && page >= 1 && page <= totalPages) {
				currentPage = page - 1;
				loadSales(currentTh, currentOrder, isDueDate);
			} else {
				alert('Ïò¨Î∞îÎ•∏ ÌéòÏù¥ÏßÄ Î≤àÌò∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî.');
				e.target.value = currentPage + 1;
			}
		}
	});

	document.getElementById("sDate").addEventListener("change", searchItems);
	document.getElementById("endDate").addEventListener("change", searchItems);
	document.getElementById("toggleDateType").addEventListener("change", searchItems);
	document.getElementById('searchTransStatus').addEventListener('change', searchItems);

	document.getElementById("sDate").setAttribute("min", today);
});
function order(sortBy) {
	const allArrows = document.querySelectorAll("th a");
	allArrows.forEach(a => {
		a.textContent = '‚Üì';
		a.style.color = '#000';
		a.style.opacity = '0.3';
	});

	if (currentTh === sortBy) {
		currentOrder = currentOrder === 'desc' ? 'asc' : 'desc';
	} else {
		currentTh = sortBy;
		currentOrder = 'asc';
	}

	currentPage = 0; // üî• Ï†ïÎ†¨ Ïãú ÌéòÏù¥ÏßÄ Ï¥àÍ∏∞Ìôî

	// ÌôîÏÇ¥Ìëú UI ÏóÖÎç∞Ïù¥Ìä∏
	const arrow = document.querySelector(`th[onclick="order('${sortBy}')"] a`);
	if (arrow) {
		arrow.textContent = currentOrder === 'asc' ? '‚Üë' : '‚Üì';
		arrow.style.color = '#000';
		arrow.style.opacity = '1';
	}

	loadSales(sortBy, currentOrder);
}


async function loadSales(sortBy, sortDirection, isDueDate) {
	const salesTableBody = document.getElementById('salesTableBody');;

	if (!salesTableBody) {
		console.warn("IDÍ∞Ä 'salesTableBody'Ïù∏ ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.");
		return;
	}

	const apiUrl = `/api/orders/sales?sortBy=${sortBy}&sortDirection=${sortDirection}&page=${currentPage}`;
	try {
		const response = await fetch(apiUrl);
		if (!response.ok) {
			throw new Error(`HTTP error! status: ${response.status}`);
		}

		const sales = await response.json();
		salesTableBody.innerHTML = '';
		totalPages = sales.totalPages;
		const paginationInfo = document.getElementById("paginationInfo");
		if (paginationInfo) {
			paginationInfo.textContent = `Ï¥ù ${sales.totalElements}Í±¥ ${sales.number + 1}/${sales.totalPages}ÌéòÏù¥ÏßÄ`;
		}

		// ÌòÑÏû¨ ÌéòÏù¥ÏßÄ ÌëúÏãú
		const currentPageInput = document.getElementById("currentPageInput");
		if (currentPageInput) {
			currentPageInput.value = sales.number + 1;
		}

		if (sales && sales.content && sales.content.length > 0) {
			rendersales(sales.content, isDueDate);
		} else {
			renderNoDataMessage();
		}
	} catch (error) {
		console.error('Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ïã§Ìå®:', error);
		renderErrorMessage('Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
	}
}

// ÌÖåÏù¥Î∏î ÎûúÎçîÎßÅ
function rendersales(sales, isDueDate) {
	const salesTableBody = document.getElementById('salesTableBody');
	salesTableBody.innerHTML = '';

	if (!sales || sales.length === 0) {
		renderNoDataMessage();
		return;
	}

	// Ï£ºÎ¨∏Îßå Ï∂îÎ¶º
	const onlySales = sales.filter(sale => sale.orderType === 'S');
	const paginationInfo = document.getElementById("paginationInfo");
	const perPage = 10;
	const totalPages = Math.ceil(onlySales.length / perPage);
	if (paginationInfo) {
		paginationInfo.textContent = `Ï¥ù ${onlySales.length}Í±¥ ${currentPage + 1}/${totalPages}ÌéòÏù¥ÏßÄ`;
	}
	if (onlySales.length > 0) {
		onlySales.forEach(sale => {
			const row = document.createElement('tr');
			row.dataset.id = sale.orderCode;
			row.onclick = () => openSalesDetail(sale.orderIdx);

			// Ï≤¥ÌÅ¨Î∞ïÏä§ ÏÖÄ
			const checkboxCell = document.createElement('td');
			const checkbox = document.createElement('input');
			checkbox.type = 'checkbox';
			checkbox.classList.add('sales-checkbox');
			checkboxCell.appendChild(checkbox);
			row.appendChild(checkboxCell);

			checkbox.addEventListener('click', (event) => {
				event.stopPropagation();
			});
			checkbox.addEventListener('change', () => {
				const checkboxes = document.querySelectorAll('#salesTableBody input[type="checkbox"]');
				const allChecked = Array.from(checkboxes).every(cb => cb.checked);
				document.getElementById('selectAllCheckbox').checked = allChecked;
			});

			// Ï£ºÎ¨∏ Í≥†Ïú† Î≤àÌò∏
			const idxCell = document.createElement('input');
			idxCell.type = 'hidden';
			idxCell.value = sale.orderIdx || '';
			row.appendChild(idxCell);

			// Ï£ºÎ¨∏Î≤àÌò∏
			const nameCell = document.createElement('td');
			nameCell.textContent = sale.orderCode || '';
			row.appendChild(nameCell);

			// ÌíàÎ™©Î™Ö
			const itemCodeCell = document.createElement('td');
			itemCodeCell.textContent = sale.itemCode || '';
			row.appendChild(itemCodeCell);

			// ÌíàÎ™© ÏΩîÎìú
			const itemNameCell = document.createElement('td');
			itemNameCell.textContent = sale.itemName || '';
			row.appendChild(itemNameCell);

			// ÏàòÎüâ
			const quantityCell = document.createElement('td');
			quantityCell.textContent = sale.quantity || '';
			row.appendChild(quantityCell);

			// Í±∞ÎûòÏ≤òÎ™Ö
			const customerNameCell = document.createElement('td');
			customerNameCell.textContent = sale.customerName || '';
			row.appendChild(customerNameCell);

			// ÎÇ©Í∏∞Ïùº ÎòêÎäî Ï∞©ÏàòÏùº
			const dateCell = document.createElement('td');
			dateCell.textContent = isDueDate ? sale.deliveryDate : sale.orderDate;
			row.appendChild(dateCell);

			// ÏÉÅÌÉú
			const orderStatusCell = document.createElement('td');
			const statusText = sale.orderStatus === 'S1' ? 'Ï∂úÍ≥†ÎåÄÍ∏∞' :
				sale.orderStatus === 'S2' ? 'Ï∂úÍ≥†Í∞ÄÎä•' :
					sale.orderStatus === 'S3' ? 'Ï∂úÍ≥†ÏôÑÎ£å' : '';
			orderStatusCell.textContent = statusText;
			row.appendChild(orderStatusCell);

			salesTableBody.appendChild(row);
		});
	} else {
		renderNoDataMessage();
	}
}

function renderNoDataMessage() {
	const salesTableBody = document.getElementById('salesTableBody');
	salesTableBody.innerHTML = '';

	const noDataRow = document.createElement('tr');
	const noDataCell = document.createElement('td');

	noDataCell.className = 'nodata';
	noDataCell.colSpan = 8;
	noDataCell.textContent = 'Îì±Î°ùÎêú Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.';
	noDataCell.setAttribute('style', 'grid-column: span 8; justify-content: center; text-align: center;');

	noDataRow.appendChild(noDataCell);
	salesTableBody.appendChild(noDataRow);
}


function renderErrorMessage(message) {
	const salesTableBody = document.getElementById('salesTableBody');
	salesTableBody.innerHTML = '';

	const errorRow = document.createElement('tr');
	const errorCell = document.createElement('td');

	errorCell.colSpan = 8;
	errorCell.textContent = message || 'Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.';
	errorCell.style.color = 'red';
	errorCell.setAttribute('style', 'grid-column: span 8; justify-content: center; text-align: center;');

	errorRow.appendChild(errorCell);
	salesTableBody.appendChild(errorRow);
}

function searchItems() {
	const searchQuery = document.getElementById('searchInput')?.value?.trim() || '';
	const dateType = document.getElementById('toggleDateType').checked ? 'deliveryDate' : 'orderDate';
	const startDate = document.getElementById('startDate').value;
	const endDate = document.getElementById('endDate').value;
	const transStatus = document.getElementById('searchTransStatus').value;
	
	
	const queryParams = new URLSearchParams({
		searchTerm: searchQuery,
		page: currentPage,
		dateType,
		startDate,
		endDate,
		transStatus
	});

	const apiUrl = `/api/orders/search?${queryParams.toString()}`;
	console.log(apiUrl);
	fetch(apiUrl)
		.then(response => response.json())
		.then(data => {
			let onlySales = data.content.filter(p => p.orderType === 'S');

			const selectedStatus = document.getElementById('searchTransStatus')?.value;
			if (selectedStatus) {
				onlySales = onlySales.filter(s => s.orderStatus === selectedStatus);
			}
			rendersales(onlySales, isDueDate);

			const paginationInfo = document.getElementById('paginationInfo');
			if (paginationInfo) {
				const total = onlySales.length;
				const perPage = 10;
				const totalPages = Math.max(1, Math.ceil(total / perPage));
				const currentPageNum = currentPage + 1;

				if (total === 0) {
					paginationInfo.textContent = 'Ï¥ù 0Í±¥';
				} else {
					paginationInfo.textContent = `Ï¥ù ${total}Í±¥ ${currentPageNum}/${totalPages}ÌéòÏù¥ÏßÄ`;
				}
			} else {
				renderNoDataMessage();
			}
		})
		.catch(error => {
			console.error('Í≤ÄÏÉâ Ïò§Î•ò:', error);
			renderErrorMessage('Í≤ÄÏÉâÏ§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌïòÏòÄÏäµÎãàÎã§.');
		});
}

function fetchOrderNo() {
	fetch('/api/orders/getno')
		.then(response => response.json())
		.then(data => {
			document.getElementById("orderNo").value = data.orderNo;
		})
		.catch(error => {
			console.error('Ï£ºÎ¨∏Î≤àÌò∏ ÏöîÏ≤≠ Ïã§Ìå®:', error);
		});
}

function formatDate(dateStr) {
	if (!dateStr) return '';
	const date = new Date(dateStr);
	const year = date.getFullYear();
	const month = String(date.getMonth() + 1).padStart(2, '0');
	const day = String(date.getDate()).padStart(2, '0');
	return `${year}-${month}-${day}`;
}

function setdate() {
	const today = new Date();
	const yyyy = today.getFullYear();
	const mm = String(today.getMonth() + 1).padStart(2, '0');
	const dd = String(today.getDate()).padStart(2, '0');
	document.getElementById('sDate').value = `${yyyy}-${mm}-${dd}`;
};

// Î™®Îã¨ Ïó¥Í∏∞
async function openModal(data = null) {
	const title = document.getElementById('modalTitle');
	title.textContent = 'Ï†ëÏàò Îì±Î°ù';
	document.getElementById('modal').style.display = 'flex';
	document.querySelector('#modalForm button[name="save"]').style.display = 'block';
	document.querySelector('#modalForm button[name="edit"]').style.display = 'none';
	const inputs = modal.querySelectorAll('input');

	if (data) {
		title.textContent = 'Ï£ºÎ¨∏ Ï†ïÎ≥¥';
		saveBtn.style.display = 'none';
		editBtn.style.display = 'block';
		document.getElementById("orderIdx").value = data.orderIdx;
		document.getElementById("orderNo").value = data.orderCode;
		document.getElementById("unitPrice").value = data.unitPrice;
		document.getElementById("itemCycleTime").value = data.cycleTime;
		document.getElementById("itemIdx").value = data.itemIdx;
		document.getElementById('orderNo').value = data.orderCode || '';
		document.getElementById('sDate').value = formatDate(data.orderDate);
		document.getElementById('dueDate').value = formatDate(data.deliveryDate);
		document.getElementById('companySearchInput').value = data.customerName || '';
		document.getElementById('selectedCustIdx').value = data.customerIdx;
		document.getElementById('itemSearchInput').value = data.itemName || '';
		document.getElementById('quantity').value = data.orderQty || '';
		document.getElementById('userName').value = data.managerName || '';
		document.getElementById('userTel').value = data.managerTel || '';
		document.getElementById('remark').value = data.remark || '';
		document.getElementById('whSearchInput').value = data.whNm || '';
		document.getElementById('selectedwhIdx').value = data.whIdx;

		inputs.forEach(input => {
			if (input.type !== 'hidden') {
				input.readOnly = true;
			}
		});
		
		document.getElementById('quantity').readOnly = false;
		document.getElementById('whSearchInput').readOnly = false;
		loadWarehouse();
	} else {
		inputs.forEach(input => {
			if (input.type !== 'hidden') {
				input.readOnly = false;
			}
		});
		fetchOrderNo(); // Ï£ºÎ¨∏Î≤àÌò∏ Ï¥àÍ∏∞Ìôî (ÏûàÎã§Î©¥)
		loadCustomer();
		loadWarehouse();
		setdate();
	}
}

// Í±∞ÎûòÏ≤ò Î™©Î°ù Î∂àÎü¨Ïò§Í∏∞
async function loadCustomer() {
	try {
		const customerResponse = await fetch('/api/customers/names');
		if (!customerResponse.ok) throw new Error('Îç∞Ïù¥ÌÑ∞ ÏöîÏ≤≠ Ïã§Ìå®');

		const customers = await customerResponse.json();
		const dataList = document.getElementById('companyList');
		dataList.innerHTML = '';
		originalCustomerOptions = [];

		customers.forEach(customer => {
			const option = document.createElement('option');
			option.value = customer.custNm;
			option.dataset.idx = customer.custIdx;
			dataList.appendChild(option);
			originalCustomerOptions.push(option); // ÌïÑÌÑ∞ÎßÅÏö©
		});
	} catch (err) {
		console.error('Îç∞Ïù¥ÌÑ∞ ÏöîÏ≤≠ Ïò§Î•ò:', err);
	}
}


// Ï∞ΩÍ≥† Î™©Î°ù Î∂àÎü¨Ïò§Í∏∞
async function loadWarehouse() {
	try {
		const response = await fetch('/api/warehouses');
		if (!response.ok) throw new Error('Ï∞ΩÍ≥† Îç∞Ïù¥ÌÑ∞ ÏöîÏ≤≠ Ïã§Ìå®');

		const warehouses = await response.json();
		const warehousesContent = warehouses.content;
		const warehouseList = document.getElementById("whList");

		warehouseList.innerHTML = '';
		warehouseOptions = [];

		warehousesContent.forEach(wh => {
			const option = document.createElement('option');
			option.value = wh.whNm;
			option.dataset.idx = wh.whIdx;
			warehouseList.appendChild(option);
			warehouseOptions.push(option);
		});
	} catch (err) {
		console.error("Ï∞ΩÍ≥† Î°úÎìú Ïò§Î•ò:", err);
	}
}
document.getElementById('whSearchInput').addEventListener('input', function() {
	const keyword = this.value.toLowerCase();
	const dataList = document.getElementById('whList');

	// ÌïÑÌÑ∞ÎßÅÎêú Ï∞ΩÍ≥† Î™©Î°ùÏùÑ ÏóÖÎç∞Ïù¥Ìä∏
	const filteredWhOptions = warehouseOptions.filter(option =>
		option.value.toLowerCase().includes(keyword)
	);

	// Í∏∞Ï°¥ datalistÎ•º ÎπÑÏö∞Í≥† ÌïÑÌÑ∞ÎßÅÎêú ÏòµÏÖòÏùÑ Îã§Ïãú Ï∂îÍ∞Ä
	dataList.innerHTML = '';
	filteredWhOptions.forEach(option => {
		dataList.appendChild(option);
	});

	// Ï∞ΩÍ≥† Î™©Î°ùÏóêÏÑú ÏûÖÎ†•Ìïú Í∞íÏù¥ ÏùºÏπòÌïòÎäî ÏòµÏÖòÏùÑ Ï∞æÍ≥†, Ìï¥Îãπ whIdxÎ•º hidden inputÏóê ÏÑ§Ï†ï
	const selectedOption = filteredWhOptions.find(option => option.value.toLowerCase() === keyword);
	if (selectedOption) {
		document.getElementById('selectedwhIdx').value = selectedOption.dataset.idx;
	} else {
		document.getElementById('selectedwhIdx').value = ''; // ÏùºÏπòÌïòÎäî Í∞íÏù¥ ÏóÜÏúºÎ©¥ Îπà Í∞íÏúºÎ°ú ÏÑ§Ï†ï
	}
});

// Í±∞ÎûòÏ≤ò ÏûÖÎ†•ÎêòÎ©¥ custIdx Ï†ÄÏû• + ÌíàÎ™© Î∂àÎü¨Ïò§Í∏∞
document.getElementById('companySearchInput').addEventListener('input', function() {
	const keyword = this.value.toLowerCase();
	const dataList = document.getElementById('companyList');
	dataList.innerHTML = '';

	originalCustomerOptions.forEach(option => {
		if (option.value.toLowerCase().includes(keyword)) {
			const clone = document.createElement('option');
			clone.value = option.value;
			clone.dataset.idx = option.dataset.idx;
			dataList.appendChild(clone);
		}
	});

	const match = Array.from(dataList.options).find(opt => opt.value === this.value);
	const custIdx = match ? match.dataset.idx : '';
	const selectedCustIdxEl = document.getElementById('selectedCustIdx');
	selectedCustIdxEl.value = custIdx;

	// custIdxÍ∞Ä ÏûàÏùÑ Í≤ΩÏö∞ÏóêÎßå ÌíàÎ™© Îç∞Ïù¥ÌÑ∞ Î°úÎî©
	const event = new Event('input');
	selectedCustIdxEl.dispatchEvent(event);
});

// custIdxÏóê Îî∞Î•∏ Ìï¥Îãπ ÌíàÎ™© Î™©Î°ù Í∞ÄÏ†∏Ïò§Í∏∞
document.getElementById('selectedCustIdx').addEventListener('input', async function() {
	const custIdx = this.value;
	const itemList = document.getElementById('itemList');
	const itemSearchInput = document.getElementById('itemSearchInput');
	const itemCycleTime = document.getElementById('itemCycleTime');

	itemList.innerHTML = '';
	itemSearchInput.value = '';
	itemCycleTime.value = '';
	itemDataMap = {}; // reset

	if (!custIdx) return;

	try {
		const response = await fetch(`/api/items/active-for-selection?custIdx=${custIdx}`);
		if (!response.ok) {
			if (response.status === 204) {
				console.log('Ìï¥Îãπ Í±∞ÎûòÏ≤òÏùò ÌíàÎ™©Ïù¥ ÏóÜÏäµÎãàÎã§.');
				return;
			}
			throw new Error('ÌíàÎ™© ÏöîÏ≤≠ Ïã§Ìå®');
		}

		const items = await response.json();

		items.forEach(item => {
			const option = document.createElement('option');
			option.value = item.itemNm;
			itemList.appendChild(option);

			// map Ï†ÄÏû•: ÌíàÎ™©Î™Ö ‚Üí cycleTime
			itemDataMap[item.itemNm] = {
				cycleTime: item.cycleTime,
				itemCost: item.itemCost,
				itemIdx: item.itemIdx
			};
		});
	} catch (err) {
		console.error('ÌíàÎ™© Î∂àÎü¨Ïò§Í∏∞ Ïò§Î•ò:', err);
	}
});

// ÌíàÎ™© ÏûÖÎ†•ÎêòÎ©¥ Ìï¥Îãπ cycleTime, itemCost hiddenÏóê Ï†ÄÏû•
document.getElementById('itemSearchInput').addEventListener('input', function() {
	const selectedItemName = this.value;
	const itemInfo = itemDataMap[selectedItemName];

	if (itemInfo) {
		document.getElementById('itemCycleTime').value = itemInfo.cycleTime || '';
		document.getElementById('itemPrice').value = itemInfo.itemCost || '';
		document.getElementById('itemIdx').value = itemInfo.itemIdx || '';

		const warehouseList = document.getElementById('whList');
		warehouseList.innerHTML = '';
		warehouseOptions.forEach(option => {
			warehouseList.appendChild(option.cloneNode(true));
		});
	} else {
		document.getElementById('itemCycleTime').value = '';
		document.getElementById('itemPrice').value = '';
		document.getElementById('itemIdx').value = '';

		// ‚ùó ÌíàÎ™©Ïù¥ ÏûòÎ™ª ÏûÖÎ†•ÎêêÏùÑ ÎïåÎßå Ï∞ΩÍ≥† Ï¥àÍ∏∞Ìôî
		const warehouseList = document.getElementById('whList');
		warehouseList.innerHTML = '';
	}
});
// ÎÇ©Í∏∞Ïùº Í≥ÑÏÇ∞
function calculateDueDate() {
	const startDateStr = startDateInput.value;
	const quantity = Number(quantityInput.value);
	const cycleTime = Number(cycleTimeInput.value); // Î∂Ñ Îã®ÏúÑ

	if (!startDateStr || !quantity || quantity <= 0 || !cycleTime || cycleTime <= 0) {
		dueDateInput.value = '';
		return;
	}

	// Ï∞©ÏàòÏùºÏùÑ Date Í∞ùÏ≤¥Î°ú ÏÉùÏÑ± (ÏûêÏ†ï 0Ïãú Í∏∞Ï§Ä)
	const startDate = new Date(startDateStr + 'T00:00:00');

	// Ï¥ù ÏÜåÏöîÏãúÍ∞Ñ(Î∂Ñ) Í≥ÑÏÇ∞
	const totalMinutes = quantity * cycleTime;

	// Ï¥ù ÏÜåÏöîÏãúÍ∞ÑÏùÑ Î∞ÄÎ¶¨Ï¥àÎ°ú Î≥ÄÌôò ÌõÑ Ï∞©ÏàòÏùºÏóê ÎçîÌï®
	const dueDate = new Date(startDate.getTime() + totalMinutes * 60 * 1000);

	// ÎÇ©Í∏∞ÏùºÏùÑ yyyy-MM-dd ÌòïÏãùÏúºÎ°ú Ìè¨Îß∑ÌåÖ
	const yyyy = dueDate.getFullYear();
	const mm = String(dueDate.getMonth() + 1).padStart(2, '0');
	const dd = String(dueDate.getDate()).padStart(2, '0');

	dueDateInput.value = `${yyyy}-${mm}-${dd}`;
}

// Ï∞©ÏàòÏùº, ÏàòÎüâ, cycleTime Î≥ÄÍ≤Ω Ïãú ÎÇ©Í∏∞Ïùº Í≥ÑÏÇ∞
startDateInput.addEventListener('change', calculateDueDate);
quantityInput.addEventListener('input', calculateDueDate);

// Ïã†Í∑úÎì±Î°ù DBÏ†ÄÏû•
document.querySelector('button[name="save"]').addEventListener('click', async () => {

	if (!document.getElementById("sDate").value) {
		alert('Ï∞©ÏàòÏùºÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
		return;
	} else if (!document.getElementById("quantity").value) {
		alert('ÏàòÎüâÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
		return;
	} else if (!document.getElementById("companySearchInput").value) {
		alert("Í±∞ÎûòÏ≤òÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.");
		return;
	} else if (!document.getElementById("itemIdx").value) {
		alert("ÌíàÎ™©ÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.");
		return;
	}

	const orderData = {
		orderCode: document.getElementById("orderNo").value,
		orderType: 'S',
		orderDate: document.getElementById("sDate").value,
		custIdx: document.getElementById("selectedCustIdx").value,
		itemIdx: document.getElementById("itemIdx").value,
		orderQty: Number(document.getElementById("quantity").value),
		unitPrice: Number(document.getElementById("itemPrice").value),
		deliveryDate: document.getElementById("dueDate").value,
		userIdx: document.getElementById("userIdx").value,
		remark: document.getElementById("remark").value,
		expectedWhIdx: document.getElementById("selectedwhIdx").value,
		orderStatus: 'S1'
	};

	try {
		const response = await fetch('/api/orders/save', {
			method: 'POST',
			headers: { 'Content-Type': 'application/json' },
			body: JSON.stringify(orderData),
		});

		if (!response.ok) throw new Error('Ï†ÄÏû• Ïã§Ìå®');

		const result = await response.json();

		let message = '‚úÖ Ï£ºÎ¨∏Ïù¥ Îì±Î°ùÎêòÏóàÏäµÎãàÎã§.';

		// ÏûêÏû¨ Î∂ÄÏ°± Í≤ΩÍ≥†Í∞Ä ÏûàÏúºÎ©¥ Î©îÏãúÏßÄÏóê Ï∂îÍ∞Ä
		if (result.productShortage) {
			message += '\n‚ö† [Ï£ºÏùò] ÏôÑÏ†úÌíà Ïû¨Í≥† Î∂ÄÏ°±. \nÏ†úÌíà ÏÉùÏÇ∞Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§';
		}
		if (result.materialShortage) {
			message += '\n‚ö† [Ï£ºÏùò] ÏõêÏûêÏû¨Í∞Ä Î∂ÄÏ°±ÌïòÏó¨ ÏÉùÏÇ∞Ïù¥ Î∂àÍ∞ÄÎä•Ìï©ÎãàÎã§.';
		}
		if (result.warnings && result.warnings.length > 0) {
			message += '\n\nüì¶ Î∂ÄÏ°± ÏûêÏû¨ Î™©Î°ù:\n' + result.warnings.join('\n');
		}

		alert(message); // ÏµúÏ¢Ö Î©îÏãúÏßÄ Ï∂úÎ†•

		closeModal();
		loadSales('deliveryDate', 'asc');
	} catch (err) {
		alert('Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
		console.error(err);
	}
});

async function openSalesDetail(orderIdx) {
	document.getElementById('modalTitle').textContent = 'Ï†ëÏàò Ï†ïÎ≥¥';

	document.querySelector('#modalForm Button[name="save"]').style.display = 'none';
	document.querySelector('#modalForm Button[name="edit"]').style.display = 'block';
	try {
		const response = await fetch(`/api/orders/detail/${orderIdx}`);
		if (!response.ok) throw new Error('Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ïã§Ìå®');

		const data = await response.json();
		openModal(data); // Î∞õÏùÄ Îç∞Ïù¥ÌÑ∞Î°ú Î™®Îã¨ Ïó¥Í∏∞
	} catch (error) {
		console.error(error);
		alert('ÏÉÅÏÑ∏ Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Îç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
	}
}

document.getElementById("editBtn").addEventListener("click", async () => {
	const orderCode = document.getElementById("orderNo").value;

	const orderData = {
		orderIdx: document.getElementById("orderIdx").value,
		orderCode: orderCode,
		orderType: 'S',
		orderDate: document.getElementById("sDate").value,
		custIdx: document.getElementById("selectedCustIdx").value,
		itemIdx: document.getElementById("itemIdx").value,
		orderQty: Number(document.getElementById("quantity").value),
		unitPrice: Number(document.getElementById("unitPrice").value),
		deliveryDate: document.getElementById("dueDate").value,
		userIdx: document.getElementById("userIdx").value,
		remark: document.getElementById("remark").value,
		expectedWhIdx: document.getElementById("selectedwhIdx").value
	};

	try {
		const response = await fetch('/api/orders/update', {
			method: 'PUT',
			headers: { 'Content-Type': 'application/json' },
			body: JSON.stringify(orderData)
		});
		if (!response.ok) throw new Error('ÏàòÏ†ï Ïã§Ìå®');

		alert('ÏàòÏ†ï ÏôÑÎ£å');
		closeModal();
		loadSales('orderIdx', 'desc', isDueDate);
	} catch (err) {
		alert('ÏàòÏ†ï Ï§ë Ïò§Î•ò Î∞úÏÉù');
		console.error(err);
	}
});

function toggleText(checkbox) {
	const label = document.getElementById('toggleState');
	isDueDate = checkbox.checked;

	label.textContent = isDueDate ? 'ÎÇ©Í∏∞Ïùº' : 'Ï∞©ÏàòÏùº';

	const dateHeader = document.getElementById('dateColumnHeader');
	if (dateHeader) {
		const arrow = dateHeader.querySelector('a'); // ÌôîÏÇ¥Ìëú ÏöîÏÜå Î∂ÑÎ¶¨
		dateHeader.innerHTML = ''; // Í∏∞Ï°¥ Ï†ÑÏ≤¥ Ï†úÍ±∞
		dateHeader.append(isDueDate ? 'ÎÇ©Í∏∞Ïùº' : 'Ï∞©ÏàòÏùº');
		if (arrow) dateHeader.appendChild(arrow); // Í∏∞Ï°¥ ÌôîÏÇ¥Ìëú Îã§Ïãú Î∂ôÏù¥Í∏∞
	}

	const sortBy = isDueDate ? 'deliveryDate' : 'orderDate';
	loadSales(sortBy, currentOrder, isDueDate);
}

function closeModal() {
	document.getElementById('modal').style.display = 'none';
	document.getElementById('modalForm').reset();

	dataList.innerHTML = '';

}

function outsideClick(e) {
	if (e.target.id === 'modal') {
		closeModal();
	}
}


async function downloadExcel() {
	const checked = document.querySelectorAll('#salesTableBody input.sales-checkbox:checked');
	const ids = Array.from(checked).map(cb =>
		cb.closest('tr').querySelector('input[type="hidden"]').value);
				
	if (ids.length === 0) {
		alert('ÏóëÏÖÄÎ°ú ÎÇ¥Î≥¥ÎÇº Ìï≠Î™©ÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
		return;
	}


	const url = `/api/orders/sale/excel?${ids.map(id => `id=${id}`).join('&')}`;
	const response = await fetch(url);

	if (!response.ok) {
		alert('ÏóëÏÖÄ Îã§Ïö¥Î°úÎìú Ïã§Ìå®');
		return;
	}

	const blob = await response.blob();


	const disposition = response.headers.get('Content-Disposition');
	let fileName = 'sale.xlsx'; // Í∏∞Î≥∏Í∞í

	if (disposition && disposition.includes('filename=')) {
		const matches = disposition.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);
		if (matches != null && matches[1]) {
			fileName = decodeURIComponent(matches[1].replace(/['"]/g, ''));
		}
	}

	const a = document.createElement('a');
	a.href = window.URL.createObjectURL(blob);
	a.download = fileName;
	a.click();
}

function printSelectedSales() {
	const checked = document.querySelectorAll('#salesTableBody input.sales-checkbox:checked');
	const ids = Array.from(checked).map(cb =>
		cb.closest('tr').querySelector('input[type="hidden"]').value
	);

	const fetchUrlFn = id => `/api/orders/printsales?${ids.map(id => `id=${id}`).join('&')}`;
	const columns = [
		{ key: 'orderCode', label: 'Ï£ºÎ¨∏Î≤àÌò∏' },
		{ key: 'itemName', label: 'ÌíàÎ™©Î™Ö' },
		{ key: 'customerName', label: 'Í±∞ÎûòÏ≤ò' },
		{ key: 'quantity', label: 'ÏàòÎüâ' },
		{ key: 'orderDate', label: 'Î∞úÏ£ºÏùº', render: formatDate },
		{ key: 'deliveryDate', label: 'ÎÇ©Í∏∞Ïùº', render: formatDate },
		{ key: 'totalPrice', label: 'Ï¥ùÏï°' },
		{ key: 'userName', label: 'Îã¥ÎãπÏûê' }
	];

	printByIds(ids, fetchUrlFn, columns, 'Ï£ºÎ¨∏ Ïù∏ÏáÑ');
}

document.getElementById('startDate').addEventListener('change', function () {
	const startDate = this.value;
	const endDateInput = document.getElementById('endDate');

	if (startDate) {
		endDateInput.min = startDate;
		if (endDateInput.value && endDateInput.value < startDate) {
			endDateInput.value = '';
		}
	}
});


